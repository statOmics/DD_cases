"0","visualize_DGE <- function(pb, genes){"
"0","    cd <- colData(pb)"
"0","    cd <- droplevels(cd)"
"0","    libSize <- pb %>%"
"0","        counts %>%"
"0","        colSums %>%"
"0","        unname"
"0",""
"0","    gg_list <- lapply(genes, function(gene){"
"0","      "
"0","        data <- data.frame(cpm = log2(counts(pb)[gene,]+0.5) - log2(libSize+1)+log2(1e6),"
"0","                           status = cd$Status_on_day_collection_summary,"
"0","                           batch = paste0(cd$Site,""_"",cd$sex))"
"0","        data$cpm[is.infinite(data$cpm)] <- NA"
"0","        "
"0","        levels(data$batch) <- c(""Cambridge_female"", ""Cambridge_male"", "
"0","                                ""Ncl_female"", ""Ncl_male"")"
"0","        "
"0","        data$status_batch <- factor(paste0(data$status, ""_"", data$batch),"
"0","                                    levels = paste0(rep(levels(data$status),each=4),"
"0","                                                    ""_"", "
"0","                                                    rep(levels(data$batch), times=2)))"
"0","        data$dotposition <- data$status_batch"
"0","        levels(data$dotposition) <- list(""0.7"" = levels(data$status_batch)[1],"
"0","                                         ""0.9"" = levels(data$status_batch)[2],"
"0","                                         ""1.1"" = levels(data$status_batch)[3],"
"0","                                         ""1.3"" = levels(data$status_batch)[4],"
"0","                                         ""1.7"" = levels(data$status_batch)[5],"
"0","                                         ""1.9"" = levels(data$status_batch)[6],"
"0","                                         ""2.1"" = levels(data$status_batch)[7],"
"0","                                         ""2.3"" = levels(data$status_batch)[8])"
"0","        data$dotposition <- as.numeric(as.character(data$dotposition))"
"0","      "
"0","        gg <- ggplot(data = data, aes(x=status,y=cpm)) +"
"0","            geom_violin() +"
"0","            geom_jitter(aes(x=dotposition, "
"0","                          y=cpm, "
"0","                          col=batch),"
"0","                      size=2, "
"0","                      width = 0.05) +"
"0","            ggtitle(paste0(""Log CPM: "",gene)) +"
"0","            theme_bw() +"
"0","            theme(plot.title = element_text(size=11))"
"0","        return(gg)"
"0","    })"
"0","    return(gg_list)"
"0","}"
"0",""
"0","visualize_DD_LOR <- function(pb, genes){"
"0","    bin_counts <- assay(pb)"
"0","    cd <- colData(pb)"
"0","    cd <- droplevels(cd)"
"0","    of <- colMeans(sweep(bin_counts, 2, cd$ncells, ""/"")) "
"0","    odds_global <- of/(1-of)"
"0",""
"0","    gg_list <- lapply(genes, function(gene){"
"0","      odds_gene <- bin_counts[gene,]/(cd$ncells - bin_counts[gene,])"
"0","      "
"0","      data <- data.frame(odds_gene = odds_gene,"
"0","                         odds_global = odds_global,"
"0","                         LOR = log(odds_gene/odds_global),"
"0","                         status = cd$Status_on_day_collection_summary,"
"0","                         batch = paste0(cd$Site,""_"",cd$sex))"
"0","      data$LOR[is.infinite(data$LOR)] <- NA"
"0","      "
"0","      levels(data$batch) <- c(""Cambridge_female"", ""Cambridge_male"", "
"0","                                ""Ncl_female"", ""Ncl_male"")"
"0","        "
"0","      data$status_batch <- factor(paste0(data$status, ""_"", data$batch),"
"0","                                  levels = paste0(rep(levels(data$status),each=4),"
"0","                                                  ""_"", "
"0","                                                  rep(levels(data$batch), times=2)))"
"0","      data$dotposition <- data$status_batch"
"0","      levels(data$dotposition) <- list(""0.7"" = levels(data$status_batch)[1],"
"0","                                       ""0.9"" = levels(data$status_batch)[2],"
"0","                                       ""1.1"" = levels(data$status_batch)[3],"
"0","                                       ""1.3"" = levels(data$status_batch)[4],"
"0","                                       ""1.7"" = levels(data$status_batch)[5],"
"0","                                       ""1.9"" = levels(data$status_batch)[6],"
"0","                                       ""2.1"" = levels(data$status_batch)[7],"
"0","                                       ""2.3"" = levels(data$status_batch)[8])"
"0","      data$dotposition <- as.numeric(as.character(data$dotposition))"
"0","      "
"0","      gg <- ggplot(data = data,aes(x=status, y= LOR)) +"
"0","          geom_violin() +"
"0","          geom_jitter(aes(x=dotposition, "
"0","                          y=LOR, "
"0","                          col=batch),"
"0","                      size=2, "
"0","                      width = 0.05) +"
"0","          ggtitle(paste0(""LOR: "", gene)) +"
"0","          theme_bw() +"
"0","          theme(plot.title = element_text(size=11))"
"0","      return(gg)"
"0","    })"
"0","    return(gg_list)"
"0","}"
"0",""
"0","visualize_DD_logprop <- function(pb, genes){"
"0","    bin_counts <- assay(pb)"
"0","    cd <- colData(pb)"
"0","    cd <- droplevels(cd)"
"0","    logprop <- log(sweep(bin_counts, 2, cd$ncells, ""/""))"
"0",""
"0","    gg_list <- lapply(genes, function(gene){"
"0",""
"0","      data <- data.frame(logprop = logprop[gene,],"
"0","                         status = cd$Status_on_day_collection_summary,"
"0","                         batch = paste0(cd$Site,""_"",cd$sex))"
"0","      data$logprop[is.infinite(data$logprop)] <- NA"
"0","      "
"0","      levels(data$batch) <- c(""Cambridge_female"", ""Cambridge_male"", "
"0","                                ""Ncl_female"", ""Ncl_male"")"
"0","        "
"0","      data$status_batch <- factor(paste0(data$status, ""_"", data$batch),"
"0","                                  levels = paste0(rep(levels(data$status),each=4),"
"0","                                                  ""_"", "
"0","                                                  rep(levels(data$batch), times=2)))"
"0","      data$dotposition <- data$status_batch"
"0","      levels(data$dotposition) <- list(""0.7"" = levels(data$status_batch)[1],"
"0","                                       ""0.9"" = levels(data$status_batch)[2],"
"0","                                       ""1.1"" = levels(data$status_batch)[3],"
"0","                                       ""1.3"" = levels(data$status_batch)[4],"
"0","                                       ""1.7"" = levels(data$status_batch)[5],"
"0","                                       ""1.9"" = levels(data$status_batch)[6],"
"0","                                       ""2.1"" = levels(data$status_batch)[7],"
"0","                                       ""2.3"" = levels(data$status_batch)[8])"
"0","      data$dotposition <- as.numeric(as.character(data$dotposition))"
"0","      "
"0","      gg <- ggplot(data = data,aes(x=status, y= logprop)) +"
"0","          geom_violin() +"
"0","          geom_jitter(aes(x=dotposition, "
"0","                          y=logprop, "
"0","                          col=batch),"
"0","                      size=2, "
"0","                      width = 0.05) +"
"0","          ggtitle(paste0(""logprop: "", gene)) +"
"0","          theme_bw() +"
"0","          theme(plot.title = element_text(size=11))"
"0","      return(gg)"
"0","    })"
"0","    return(gg_list)"
"0","}"
"0",""
"0","visualize_DD_prop <- function(pb, genes){"
"0","    bin_counts <- assay(pb)"
"0","    cd <- colData(pb)"
"0","    cd <- droplevels(cd)"
"0","    proportions <- sweep(bin_counts, 2, cd$ncells, ""/"")"
"0",""
"0","    gg_list <- lapply(genes, function(gene){"
"0",""
"0","        data <- data.frame(proportion = proportions[gene,],"
"0","                           status = cd$Status_on_day_collection_summary,"
"0","                           batch = paste0(cd$Site,""_"",cd$sex))"
"0","        data$proportion[is.infinite(data$proportion)] <- NA"
"0","        "
"0","        levels(data$batch) <- c(""Cambridge_female"", ""Cambridge_male"", "
"0","                                ""Ncl_female"", ""Ncl_male"")"
"0","        "
"0","        data$status_batch <- factor(paste0(data$status, ""_"", data$batch),"
"0","                                    levels = paste0(rep(levels(data$status),each=4),"
"0","                                             ""_"", "
"0","                                             rep(levels(data$batch), times=2)))"
"0","        "
"0","        data$dotposition <- data$status_batch"
"0","        levels(data$dotposition) <- list(""0.7"" = levels(data$status_batch)[1],"
"0","                                         ""0.9"" = levels(data$status_batch)[2],"
"0","                                         ""1.1"" = levels(data$status_batch)[3],"
"0","                                         ""1.3"" = levels(data$status_batch)[4],"
"0","                                         ""1.7"" = levels(data$status_batch)[5],"
"0","                                         ""1.9"" = levels(data$status_batch)[6],"
"0","                                         ""2.1"" = levels(data$status_batch)[7],"
"0","                                         ""2.3"" = levels(data$status_batch)[8])"
"0","        data$dotposition <- as.numeric(as.character(data$dotposition))"
"0","        "
"0","        gg <- ggplot(data = data,aes(x=status, y= proportion)) +"
"0","            geom_violin() +"
"0","            geom_jitter(aes(x=dotposition, "
"0","                            y=proportion, "
"0","                            col=batch),"
"0","                        size=2, "
"0","                        width = 0.05) +"
"0","            ylim(-0.01,1.01) + "
"0","            ggtitle(paste0(""prop: "", gene)) +"
"0","            theme_bw() +"
"0","            theme(plot.title = element_text(size=11))"
"0","      return(gg)"
"0","    })"
"0","    return(gg_list)"
"0","}"
